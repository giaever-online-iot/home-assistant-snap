name: Auto Update from Home Assistant Core

on:
  schedule:
    # Check for new tags every Friday at 23:00 UTC
    - cron: '0 23 * * 5'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Specific tag to build (optional)'
        required: false
        type: string

jobs:
  check-and-create-pr:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.check.outputs.new_tag }}
      should_create_pr: ${{ steps.check.outputs.should_create_pr }}
      pr_number: ${{ steps.create_pr.outputs.pull-request-number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for new Home Assistant Core release
        id: check
        run: |
          set -e

          # If manual trigger with specific tag
          if [ -n "${{ inputs.tag }}" ]; then
            NEW_TAG="${{ inputs.tag }}"
            echo "Manual trigger with tag: $NEW_TAG"
            echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
            echo "should_create_pr=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Fetch latest tags from home-assistant/core
          git ls-remote --tags --refs https://github.com/home-assistant/core.git | \
            awk '{print $2}' | \
            sed 's|refs/tags/||' | \
            grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | \
            sort -V | \
            tail -1 > /tmp/latest_ha_tag.txt

          LATEST_HA_TAG=$(cat /tmp/latest_ha_tag.txt)
          echo "Latest Home Assistant Core tag: $LATEST_HA_TAG"

          # Get current version from snapcraft.yaml
          CURRENT_VERSION=$(grep "^version:" snap/snapcraft.yaml | awk '{print $2}' | tr -d "'\"")
          echo "Current snap version: $CURRENT_VERSION"

          # Compare versions
          if [ "$LATEST_HA_TAG" != "$CURRENT_VERSION" ]; then
            echo "New version available: $LATEST_HA_TAG"
            echo "new_tag=$LATEST_HA_TAG" >> $GITHUB_OUTPUT
            echo "should_create_pr=true" >> $GITHUB_OUTPUT
          else
            echo "Already up to date"
            echo "should_create_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if PR already exists
        if: steps.check.outputs.should_create_pr == 'true'
        id: check_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NEW_VERSION="${{ steps.check.outputs.new_tag }}"

          # Check if a PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "auto-update/$NEW_VERSION" --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists: #$EXISTING_PR"
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "existing_pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            echo "No existing PR found for version $NEW_VERSION"
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Update version in snapcraft.yaml
        if: steps.check.outputs.should_create_pr == 'true' && steps.check_pr.outputs.pr_exists == 'false'
        run: |
          NEW_VERSION="${{ steps.check.outputs.new_tag }}"
          echo "Updating snapcraft.yaml to version $NEW_VERSION"
          sed -i "s/^version: .*/version: '$NEW_VERSION'/" snap/snapcraft.yaml

          # Verify the change
          grep "^version:" snap/snapcraft.yaml

      - name: Build snap
        if: steps.check.outputs.should_create_pr == 'true' && steps.check_pr.outputs.pr_exists == 'false'
        uses: snapcore/action-build@v1
        id: build

      - name: Review snap
        if: steps.check.outputs.should_create_pr == 'true' && steps.check_pr.outputs.pr_exists == 'false'
        uses: diddlesnaps/snapcraft-review-action@v1
        with:
          snap: ${{ steps.build.outputs.snap }}
          isClassic: 'false'

      - name: Upload snap artifact
        if: steps.check.outputs.should_create_pr == 'true' && steps.check_pr.outputs.pr_exists == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: home-assistant-snap-${{ steps.check.outputs.new_tag }}
          path: ${{ steps.build.outputs.snap }}
          retention-days: 30

      - name: Create Pull Request
        if: steps.check.outputs.should_create_pr == 'true' && steps.check_pr.outputs.pr_exists == 'false'
        uses: peter-evans/create-pull-request@v6
        id: create_pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update to ${{ steps.check.outputs.new_tag }}"
          branch: auto-update/${{ steps.check.outputs.new_tag }}
          delete-branch: true
          title: "Update to Home Assistant ${{ steps.check.outputs.new_tag }}"
          body: |
            ## ğŸ  Home Assistant Update

            This PR updates Home Assistant to version **${{ steps.check.outputs.new_tag }}**.

            ### âœ… Build Status
            The snap has been successfully built and tested in this workflow run.
            - Build artifacts are available in the workflow run artifacts
            - Snap review passed

            ### ğŸ“‹ Changes
            - Updated `version` in `snap/snapcraft.yaml` to `${{ steps.check.outputs.new_tag }}`

            ### ğŸ”— Links
            - [Home Assistant Release Notes](https://github.com/home-assistant/core/releases/tag/${{ steps.check.outputs.new_tag }})
            - [This Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Download Built Snap](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### âœ”ï¸ Review Checklist
            - [x] Snap build completed successfully
            - [ ] Review Home Assistant changelog for breaking changes
            - [ ] Verify version update in `snapcraft.yaml`
            - [ ] Test the snap locally if needed (download from artifacts)
            - [ ] Merge when ready to release

            ### ğŸš€ After Merge
            After merging this PR, you can:
            1. Create a release manually with the tag `${{ steps.check.outputs.new_tag }}`
            2. Build and publish to snap store
            3. Update channel information as needed

            ---
            *This PR was created automatically by the [Auto Update workflow](${{ github.server_url }}/${{ github.repository }}/blob/next/.github/workflows/auto-update.yml)*
            *The snap was built and tested as part of this workflow.*
          labels: |
            auto-update
            version-update
          assignees: jmgiaever
          reviewers: ThyMYthOS
          draft: false

      - name: Report PR creation
        if: steps.check.outputs.should_create_pr == 'true'
        run: |
          if [ "${{ steps.check_pr.outputs.pr_exists }}" == "true" ]; then
            echo "âš ï¸ PR already exists for Home Assistant ${{ steps.check.outputs.new_tag }}"
            echo "ğŸ“‹ Existing PR: #${{ steps.check_pr.outputs.existing_pr_number }}"
            echo "ğŸ”„ Skipping build and PR creation"
          else
            echo "âœ… Pull request created for Home Assistant ${{ steps.check.outputs.new_tag }}"
            echo "ğŸ“‹ Pull Request: ${{ steps.create_pr.outputs.pull-request-url }}"
            echo "ğŸ“¦ Snap artifact: home-assistant-snap-${{ steps.check.outputs.new_tag }}"
            echo "ğŸ”„ Snap was built and tested successfully in this workflow"
          fi
